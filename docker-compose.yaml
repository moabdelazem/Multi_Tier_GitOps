services:
    api:
        build: ./api
        ports:
            - "8888:8888"
        environment:
            - PORT=:8888
            - ENVIRONMENT=production
            - LOG_FORMAT=json
            - LOG_LEVEL=info
            - LOG_TIME_FORMAT=rfc3339
            - DB_HOST=db
            - DB_PORT=5432
            - DB_USER=dummyuser
            - DB_PASSWORD=dummypass
            - DB_NAME=multi_tier_db
            - DB_SSLMODE=disable
            - DB_MAX_OPEN_CONNS=25
            - DB_MAX_IDLE_CONNS=5
            - DB_CONN_MAX_LIFETIME=5m
            - DB_CONN_MAX_IDLE_TIME=10m
            - CORS_ALLOWED_ORIGINS=*
            - CORS_ALLOWED_METHODS=GET,POST,PUT,DELETE,OPTIONS
            - CORS_ALLOWED_HEADERS=Accept,Authorization,Content-Type,X-Request-ID
            - CORS_EXPOSED_HEADERS=X-Request-ID
            - CORS_ALLOW_CREDENTIALS=false
            - CORS_MAX_AGE=300
        depends_on:
            db:
                condition: service_healthy
            migrate:
                condition: service_completed_successfully
        restart: unless-stopped
        networks:
            - multi_tier_network
        
    db:
        image: postgres:16-alpine
        ports:
            - "5432:5432"
        environment:
            - POSTGRES_USER=dummyuser
            - POSTGRES_PASSWORD=dummypass
            - POSTGRES_DB=multi_tier_db
        volumes:
            - postgres_db_data:/var/lib/postgresql/data
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U dummyuser"]
            interval: 5s
            timeout: 5s
            retries: 5
        restart: unless-stopped
        networks:
            - multi_tier_network

    migrate:
        image: migrate/migrate
        volumes:
            - ./api/cmd/migrations:/migrations
        command: ["-path", "/migrations", "-database", "postgres://dummyuser:dummypass@db:5432/multi_tier_db?sslmode=disable", "up"]
        depends_on:
            db:
                condition: service_healthy
        restart: on-failure
        networks:
            - multi_tier_network

volumes:
    postgres_db_data:

networks:
    multi_tier_network:
        driver: bridge